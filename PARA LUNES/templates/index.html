<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management v1.0 - WEBCAM</title>
    
    <!-- External CSS Libraries (FIXED: Using direct relative paths instead of Flask url_for) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Assuming w3.css is located at css/w3.css relative to the template root -->
    <link rel="stylesheet" href="css/w3.css">
    
    <style>
        body { background-color: #f4f4f4; font-family: 'Inter', sans-serif; }
        .header { background-color: #3f51b5; color: white; padding: 15px; }
        .form-container, .table-container { 
            background: white; 
            padding: 20px; 
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            margin-bottom: 20px;
        }
        
        /* Webcam View Port Styles - FIXED SELECTOR: Must use #mycamera */
        #mycamera {
            width:320px;
            height:240px;
            border: 3px solid #3f51b5;
            border-radius: 8px;
            margin: 0 auto;
            display: block;
        }
        
        /* Snapshot Preview Styles */
        #myresult {
            width: 150px; 
            height: 150px; 
            border: 2px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        #myresult img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Table Image Thumbnails */
        .student-thumb {
            width: 45px;
            height: 45px;
            object-fit: cover;
            border-radius: 50%; 
            border: 3px solid #673ab7;
        }

        /* Custom Message Box (Non-blocking replacement for alert/confirm) */
        .custom-message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            z-index: 2000; 
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            padding: 15px;
            animation: slideIn 0.5s forwards;
        }
        
        @keyframes slideIn {
            from { right: -350px; opacity: 0; }
            to { right: 20px; opacity: 1; }
        }

        /* Mobile responsive table improvements */
        @media (max-width: 768px) {
            .student-row > td:nth-child(3),
            .student-row > td:nth-child(4),
            .student-row > td:nth-child(5),
            .student-row > td:nth-child(6) {
                display: none;
            }
            .d-md-none { display: table-cell !important; }
        }
    </style>
</head>
<body class="w3-light-gray">

<!-- Custom Message Box for non-blocking notifications -->
<div id="messageBox" class="custom-message-box alert" role="alert">
    <span id="messageContent"></span>
    <button type="button" class="btn-close float-end" onclick="hideMessageBox()"></button>
</div>

<div class="header">
    <div class="container-fluid">
        <h4>Student Management v1.0 - WEBCAM</h4>
    </div>
</div>

<div class="container-fluid mt-4">
    <!-- Flash Messages (Jinja2 syntax removed for raw HTML compatibility) -->
    <!-- Note: If using this with Flask, you would need to re-add the {% with messages... %} block -->
    
    <div class="row">
        <!-- LEFT PANEL: FORM & CAMERA -->
        <div class="col-md-4">
            <div class="form-container">
                <h5 class="mb-3 border-bottom pb-2 text-primary">STUDENT ENROLLMENT</h5>
                
                <form id="studentForm">
                    <!-- CAMERA VIEW PORT - This is where Webcam.js attaches -->
                    <div class="text-center mb-3">
                        <div id="mycamera" class="w3-margin-bottom"></div>
                        <button type="button" class="btn w3-red w3-round shadow-sm" onclick="takepicture()">TAKE PHOTO</button>
                        <!-- Status message for camera issues -->
                        <div id="camera-status" class="mt-2 text-muted">Initializing camera...</div> 
                    </div>
                    
                    <!-- Form Fields -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">IDNO</label>
                        <input type="text" class="form-control" name="idno" id="idno" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">LASTNAME</label>
                        <input type="text" class="form-control" name="lastname" id="lastname" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">FIRSTNAME</label>
                        <input type="text" class="form-control" name="firstname" id="firstname" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">COURSE</label>
                        <select class="form-select" name="course" id="course" required>
                            <option value="">-- Select Course --</option>
                            <option value="BSIT">BSIT - Information Technology</option>
                            <option value="BSCS">BSCS - Computer Science</option>
                            <option value="BSCPE">BSCPE - Computer Engineering</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">LEVEL</label>
                        <select class="form-select" name="level" id="level" required>
                            <option value="">-- Select Level --</option>
                            <option value="1">1st Year</option>
                            <option value="2">2nd Year</option>
                            <option value="3">3rd Year</option>
                            <option value="4">4th Year</option>
                        </select>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-primary shadow-sm" onclick="savestudent()">SAVE STUDENT</button>
                        <button type="button" class="btn btn-secondary shadow-sm" onclick="resetForm()">CANCEL</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- RIGHT PANEL: TABLE & SNAPSHOT PREVIEW -->
        <div class="col-md-8">
            <div class="table-container">
                
                <!-- SNAPSHOT PREVIEW AREA -->
                <h5 class="mb-3 border-bottom pb-2 text-info">SNAPSHOT PREVIEW</h5>
                <div class="d-flex flex-column flex-sm-row align-items-center w3-border w3-padding w3-margin-bottom rounded-3 bg-light">
                    <div id="myresult" class="me-sm-3 mb-3 mb-sm-0">
                         <!-- Placeholder for the captured image (FIXED: Using relative path) -->
                         <img id="imageprev" src="" onerror="this.src='uploads/default_user.png';" style="width:100%; height:100%; object-fit: cover;" alt="Snapshot Preview">
                    </div>
                    <div class="flex-grow-1 text-center text-sm-start">
                        <p class="mb-1">IDNO: <b id="myidno">---</b></p>
                        <p class="mb-1">NAME: <b id="mylastname">---</b>, <b id="myfirstname">---</b></p>
                        <p class="mb-0">COURSE: <b id="mycourse">---</b> LEVEL: <b id="mylevel">---</b></p>
                    </div>
                </div>

                <!-- STUDENT LIST TABLE -->
                <h5 class="mb-3 border-bottom pb-2 text-success">STUDENT LIST (Only visible when connected to Flask)</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>PHOTO</th>
                                <th>IDNO</th>
                                
                                <th class="d-none d-md-table-cell">LAST NAME</th>
                                <th class="d-none d-md-table-cell">FIRST NAME</th>
                                <th class="d-none d-md-table-cell">COURSE</th>
                                <th class="d-none d-md-table-cell">LEVEL</th>

                                <th class="d-md-none">NAME</th>
                                <th class="d-md-none">COURSE/LVL</th>

                                <th>ACTION</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- The list of students is only populated when rendered by the Flask server -->
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    Student data will appear here when served by Flask (app.py).
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>&copy; Student Management System 2025</p>
    </div>
</div>

<!-- JavaScript Includes -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Webcam.js Library (FIXED: Using direct relative path) -->
<!-- Assuming webcam.min.js is located at js/webcam.min.js relative to the template root -->
<script src="js/webcam.min.js"></script> 
<script>
    // --- Helper Functions for Custom Message Box (Replacing alert/confirm) ---
    
    let messageTimeout; 

    function showMessageBox(message, type = 'info') {
        clearTimeout(messageTimeout); 

        const box = document.getElementById('messageBox');
        const content = document.getElementById('messageContent');
        
        // Reset class and apply new type
        box.className = `custom-message-box alert alert-${type} alert-dismissible fade show`;
        content.textContent = message;
        box.style.display = 'block';

        // Remove confirmation buttons if they were present
        const existingConfirmBtn = document.getElementById('confirmBtn');
        const existingCancelBtn = document.getElementById('cancelBtn');
        if (existingConfirmBtn) existingConfirmBtn.remove();
        if (existingCancelBtn) existingCancelBtn.remove();

        // Auto-hide for standard messages
        if (type !== 'danger' || message.includes('Saved')) { 
            messageTimeout = setTimeout(hideMessageBox, 4000);
        }
    }

    function hideMessageBox() {
        const box = document.getElementById('messageBox');
        if (box) box.style.display = 'none';
        clearTimeout(messageTimeout);
    }

    /** Displays a confirmation message for deleting a student. */
    function confirmDelete(name, id) {
        clearTimeout(messageTimeout); 
        
        showMessageBox(`Are you sure you want to delete student: ${name}?`, 'danger');
        const box = document.getElementById('messageBox');
        
        // 1. Add confirm button
        const confirmBtn = document.createElement('button');
        confirmBtn.id = 'confirmBtn';
        confirmBtn.className = 'btn btn-sm btn-danger ms-2';
        confirmBtn.textContent = 'Yes, Delete';
        confirmBtn.onclick = () => {
            hideMessageBox();
            // Programmatically submit the delete form to Flask
            const form = document.createElement('form');
            form.action = `/delete/${id}`;
            form.method = 'POST';
            document.body.appendChild(form);
            form.submit();
        };

        // 2. Add cancel button
        const cancelBtn = document.createElement('button');
        cancelBtn.id = 'cancelBtn';
        cancelBtn.className = 'btn btn-sm btn-secondary ms-2';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = hideMessageBox;
        
        // Insert buttons right after the message content
        const closeBtn = box.querySelector('.btn-close');
        box.insertBefore(cancelBtn, closeBtn);
        box.insertBefore(confirmBtn, cancelBtn);
    }
    
    // -----------------------------------------------------------------
    // WEBCAM.JS INTEGRATION LOGIC
    // -----------------------------------------------------------------
    // Check if Webcam object is available before calling methods
    if (typeof Webcam !== 'undefined') {
        Webcam.set({
            width:320,
            height:240,
            dest_width:320,
            dest_height:240,
            image_type:'jpeg',
            jpeg_quality:90,
            // Success hook for camera readiness
            onready: function() {
                document.getElementById('camera-status').textContent = 'Camera Ready. Click TAKE PHOTO.';
                document.getElementById('camera-status').className = 'mt-2 text-success fw-bold';
            },
            // Error hook for camera failure
            on_error: function(err) {
                console.error("Webcam Error:", err);
                document.getElementById('camera-status').textContent = 'Error: Cannot access camera. Check permissions.';
                document.getElementById('camera-status').className = 'mt-2 text-danger fw-bold';
                showMessageBox("FATAL ERROR: Camera access failed. Please ensure you grant permission.", 'danger');
            }
        });
        
        function startWebcam() {
            // This attaches the camera to the div with id="mycamera"
            Webcam.attach("#mycamera");
        }

        // Initialize on page load to ensure the DOM is ready
        window.onload = function() {
            startWebcam();
        }
    } else {
        // Fallback message if Webcam.js failed to load
        window.onload = function() {
            console.error("Webcam.js library is not defined. Check the script path.");
            document.getElementById('camera-status').textContent = 'Library Error: Webcam.js not loaded. Cannot initialize camera.';
            document.getElementById('camera-status').className = 'mt-2 text-danger fw-bold';
        }
    }


    // Function to capture the snapshot
    function takepicture(){
        if (typeof Webcam === 'undefined') {
             showMessageBox("Camera library not loaded. Cannot take picture.", 'danger');
             return;
        }

        const idno = document.getElementById('idno').value.trim();
        const lastname = document.getElementById('lastname').value.trim();
        const firstname = document.getElementById('firstname').value.trim();

        if (!idno || !lastname || !firstname) {
            showMessageBox("Please enter IDNO, Last Name, and First Name before taking a picture.", 'warning');
            return;
        }

        Webcam.snap( function(data_uri) {
            // Display the snapshot in the result div
            const imgElement = document.getElementById('imageprev');
            if (imgElement) {
                imgElement.src = data_uri;
            } 
            
            // Populate the data preview next to the image
            document.getElementById('myidno').innerHTML=idno;
            document.getElementById('mylastname').innerHTML=lastname;
            document.getElementById('myfirstname').innerHTML=firstname;
            document.getElementById('mycourse').innerHTML=document.getElementById('course').value;
            document.getElementById('mylevel').innerHTML=document.getElementById('level').value;

            showMessageBox("Photo successfully captured!", 'success');
        } );
    }
    
    // Function to upload the image and student details to Flask
    function savestudent(){
        if (typeof Webcam === 'undefined') {
             showMessageBox("Camera library not loaded. Cannot save data.", 'danger');
             return;
        }
        
        const imageElement = document.getElementById('imageprev');
        const image = imageElement ? imageElement.src : null;
        
        const idno = document.getElementById('idno').value.trim();
        const lastname = document.getElementById('lastname').value.trim();
        const firstname = document.getElementById('firstname').value.trim();
        const course = document.getElementById('course').value;
        const level = document.getElementById('level').value;
        
        // Frontend Validation
        if (!idno || !lastname || !firstname || !course || !level) {
            showMessageBox("All student information fields must be filled out!", 'danger');
            return;
        }
        
        // Check if a picture was actually taken (and not the default placeholder)
        if (!image || image.includes('default_user.png') || !image.startsWith('data:image/jpeg')) {
            showMessageBox("Please take a picture using the webcam first!", 'danger');
            return;
        }
        
        showMessageBox("Saving student data... Please wait.", 'info');

        // Encode student details for the URL query string
        const encodedLastname = encodeURIComponent(lastname);
        const encodedFirstname = encodeURIComponent(firstname);
        const url = `/savestudent?idno=${idno}&lastname=${encodedLastname}&firstname=${encodedFirstname}&course=${course}&level=${level}`;
        
        Webcam.upload(image, url, function(code, text) {
            if (code === 200) {
                 showMessageBox("Student Information Saved! Refreshing list...", 'success');
                 // Wait a moment then refresh the page
                 setTimeout(() => window.location.reload(), 1000);
            } else if (code === 409) {
                 showMessageBox("Error: ID Number already exists. Cannot save duplicate record.", 'danger');
            } else {
                 showMessageBox(`Error saving student (Code: ${code}): ${text}`, 'danger');
            }
        });
    }

    // Reset Form Logic (CANCEL Button)
    function resetForm() {
        if (typeof Webcam !== 'undefined') {
            Webcam.reset(); 
        }
        
        // Clear inputs
        document.getElementById('studentForm').reset();
        
        // Reset the data preview text
        document.getElementById('myidno').innerHTML= '---';
        document.getElementById('mylastname').innerHTML= '---';
        document.getElementById('myfirstname').innerHTML= '---';
        document.getElementById('mycourse').innerHTML= '---';
        document.getElementById('mylevel').innerHTML= '---';

        // Reset the preview image to trigger the onerror fallback (default placeholder)
        const imgElement = document.getElementById('imageprev');
        if (imgElement) imgElement.src = ''; 

        // Re-attach the camera for live feed
        if (typeof Webcam !== 'undefined') {
            startWebcam(); 
        }

        showMessageBox("Form reset. Camera re-initialized.", 'info');
    }
</script>
</body>
</html>